name: PR Validation üîç

# Este workflow valida PRs automaticamente
# - Verifica conven√ß√µes de commits
# - Valida branch naming (GitFlow)
# - Roda testes r√°pidos
# - Verifica documenta√ß√£o

on:
  pull_request:
    branches:
      - main
      - develop
    types: [opened, synchronize, reopened, edited]

jobs:
  # ==============================================================================
  # VALIDA√á√ÉO DE GITFLOW
  # ==============================================================================
  validate-gitflow:
    name: Validate GitFlow Branch üåø
    runs-on: ubuntu-latest
    steps:
      - name: Check branch name
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          echo "Branch name: $BRANCH_NAME"
          
          # Validar naming convention
          if [[ $BRANCH_NAME =~ ^(feature|bugfix|hotfix|release)/.+ ]]; then
            echo "‚úÖ Branch name follows GitFlow convention"
          else
            echo "‚ùå Branch name must follow GitFlow pattern:"
            echo "   - feature/*  (para novas features)"
            echo "   - bugfix/*   (para corre√ß√µes)"
            echo "   - hotfix/*   (para corre√ß√µes cr√≠ticas de produ√ß√£o)"
            echo "   - release/*  (para prepara√ß√£o de release)"
            exit 1
          fi
      
      - name: Validate target branch
        run: |
          SOURCE_BRANCH="${{ github.head_ref }}"
          TARGET_BRANCH="${{ github.base_ref }}"
          
          echo "Source: $SOURCE_BRANCH ‚Üí Target: $TARGET_BRANCH"
          
          # Validar fluxo correto
          if [[ $SOURCE_BRANCH =~ ^(feature|bugfix)/ ]]; then
            if [[ $TARGET_BRANCH != "develop" ]]; then
              echo "‚ùå feature/* e bugfix/* devem ter merge para develop"
              exit 1
            fi
          elif [[ $SOURCE_BRANCH =~ ^release/ ]]; then
            if [[ $TARGET_BRANCH != "main" && $TARGET_BRANCH != "develop" ]]; then
              echo "‚ùå release/* deve ter merge para main ou develop"
              exit 1
            fi
          elif [[ $SOURCE_BRANCH =~ ^hotfix/ ]]; then
            if [[ $TARGET_BRANCH != "main" && $TARGET_BRANCH != "develop" ]]; then
              echo "‚ùå hotfix/* deve ter merge para main ou develop"
              exit 1
            fi
          fi
          
          echo "‚úÖ Target branch is correct for this branch type"

  # ==============================================================================
  # VALIDA√á√ÉO DE COMMITS
  # ==============================================================================
  validate-commits:
    name: Validate Commit Messages üìù
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Check commit messages
        run: |
          echo "Validating commits follow Conventional Commits..."
          
          # Get commits in this PR
          COMMITS=$(git log --format=%s ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          
          INVALID_COMMITS=()
          while IFS= read -r commit; do
            # Check if commit follows pattern: type(scope): message
            # Types: feat, fix, docs, style, refactor, test, chore, perf, ci
            if [[ ! $commit =~ ^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?:.+ ]]; then
              INVALID_COMMITS+=("$commit")
            fi
          done <<< "$COMMITS"
          
          if [ ${#INVALID_COMMITS[@]} -gt 0 ]; then
            echo "‚ùå The following commits don't follow Conventional Commits:"
            printf '%s\n' "${INVALID_COMMITS[@]}"
            echo ""
            echo "Formato correto:"
            echo "  tipo(escopo): descri√ß√£o"
            echo ""
            echo "Tipos v√°lidos: feat, fix, docs, style, refactor, test, chore, perf, ci"
            echo ""
            echo "Exemplos:"
            echo "  feat(player): adiciona sistema de invent√°rio"
            echo "  fix(ui): corrige bug de menu pausado"
            echo "  docs: atualiza README com instru√ß√µes"
            exit 1
          fi
          
          echo "‚úÖ All commits follow Conventional Commits"

  # ==============================================================================
  # TESTES R√ÅPIDOS
  # ==============================================================================
  quick-tests:
    name: Quick Tests ‚ö°
    runs-on: ubuntu-latest
    env:
      UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
    steps:
      - uses: actions/checkout@v3
        with:
          lfs: true

      - name: Cache Unity Library
        uses: actions/cache@v3
        with:
          path: Library
          key: Library-quicktest-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-quicktest-
            Library-

      # Rodar apenas EditMode tests (mais r√°pido)
      - name: Run EditMode tests
        uses: game-ci/unity-test-runner@v4
        with:
          testMode: EditMode
          githubToken: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: Test results (EditMode)
          path: artifacts/

  # ==============================================================================
  # VERIFICA√á√ÉO DE DOCUMENTA√á√ÉO
  # ==============================================================================
  check-documentation:
    name: Check Documentation üìö
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Check if documentation needs update
        run: |
          echo "Checking if significant changes require documentation updates..."
          
          # Check if changes include new features or breaking changes
          if git diff --name-only ${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }} | grep -qE "Assets/Scripts/|Packages/manifest.json"; then
            echo "‚ÑπÔ∏è Changes detected in Scripts or Packages"
            echo "Please ensure CLAUDE.md or ReadMe.md is updated if needed"
          fi
          
          # Check if CHANGELOG.md was updated
          if git diff --name-only ${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }} | grep -q "CHANGELOG.md"; then
            echo "‚úÖ CHANGELOG.md was updated"
          else
            echo "‚ö†Ô∏è Consider updating CHANGELOG.md for this change"
          fi

  # ==============================================================================
  # VERIFICA√á√ÉO DE ARQUIVOS
  # ==============================================================================
  check-files:
    name: Check Files üìÅ
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Check for debug or temp files
        run: |
          echo "Checking for debug/temp files that shouldn't be committed..."
          
          PROBLEMATIC_FILES=()
          
          # Check for common debug patterns
          if git diff --name-only ${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }} | grep -qE "\.log$|\.tmp$|Debug\.cs$"; then
            PROBLEMATIC_FILES+=($(git diff --name-only ${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }} | grep -E "\.log$|\.tmp$|Debug\.cs$"))
          fi
          
          if [ ${#PROBLEMATIC_FILES[@]} -gt 0 ]; then
            echo "‚ö†Ô∏è The following files might be debug/temp files:"
            printf '%s\n' "${PROBLEMATIC_FILES[@]}"
            echo "Please verify these files should be committed"
          else
            echo "‚úÖ No obvious debug/temp files detected"
          fi

      - name: Check for large files
        run: |
          echo "Checking for large files (>10MB)..."
          
          LARGE_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }} | \
            xargs -I{} sh -c 'if [ -f "{}" ]; then stat -f%z "{}"; fi' 2>/dev/null | \
            awk '$1 > 10485760')
          
          if [ ! -z "$LARGE_FILES" ]; then
            echo "‚ö†Ô∏è Large files detected (>10MB)"
            echo "Consider using Git LFS for large assets"
          else
            echo "‚úÖ No excessively large files detected"
          fi

  # ==============================================================================
  # RESUMO
  # ==============================================================================
  pr-validation-summary:
    name: PR Validation Summary ‚úÖ
    needs: [validate-gitflow, validate-commits, quick-tests, check-documentation, check-files]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check validation results
        run: |
          if [ "${{ needs.validate-gitflow.result }}" == "success" ] && \
             [ "${{ needs.validate-commits.result }}" == "success" ] && \
             [ "${{ needs.quick-tests.result }}" == "success" ]; then
            echo "‚úÖ All validations passed!"
            echo "PR is ready for review"
          else
            echo "‚ùå Some validations failed"
            echo "Please fix the issues above before requesting review"
            exit 1
          fi

      - name: Comment on PR
        uses: actions/github-script@v6
        if: always()
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => {
              return comment.user.type === 'Bot' && comment.body.includes('PR Validation Results');
            });
            
            const output = `## PR Validation Results ü§ñ
            
            | Check | Status |
            |-------|--------|
            | GitFlow Branch | ${{ needs.validate-gitflow.result == 'success' && '‚úÖ' || '‚ùå' }} |
            | Commit Messages | ${{ needs.validate-commits.result == 'success' && '‚úÖ' || '‚ùå' }} |
            | Quick Tests | ${{ needs.quick-tests.result == 'success' && '‚úÖ' || '‚ùå' }} |
            | Documentation | ${{ needs.check-documentation.result == 'success' && '‚úÖ' || '‚ö†Ô∏è' }} |
            | Files Check | ${{ needs.check-files.result == 'success' && '‚úÖ' || '‚ö†Ô∏è' }} |
            
            ${{ needs.validate-gitflow.result == 'success' && needs.validate-commits.result == 'success' && needs.quick-tests.result == 'success' && '‚úÖ **All critical validations passed!** PR is ready for review.' || '‚ùå **Some validations failed.** Please check the details above.' }}
            
            ---
            *Automated validation by GitHub Actions*
            `;
            
            if (botComment) {
              github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: output
              });
            } else {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: output
              });
            }
